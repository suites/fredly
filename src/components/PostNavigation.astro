---
import { getCollection } from 'astro:content';
import { getPostRouteSlug } from '@/utils/post-route.util';
import PostCard from './PostCard.astro';
import type { BlogPost } from '@/types';

// 현재 포스트의 슬러그 가져오기
const currentSlug = Astro.url.pathname.split('/').pop() || '';

// 모든 포스트 가져오기 (날짜순 정렬)
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => {
  const dateA = ('date' in a.data ? a.data.date : null) || a.data.pubDate || new Date(0);
  const dateB = ('date' in b.data ? b.data.date : null) || b.data.pubDate || new Date(0);
  return new Date(dateB).getTime() - new Date(dateA).getTime();
});

// 현재 포스트의 인덱스 찾기 (slug 매칭 로직 개선)
const currentIndex = sortedPosts.findIndex((post) => getPostRouteSlug(post) === currentSlug);

// 이전/다음 포스트 찾기
const prevPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const nextPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;

function convertToBlogPost(post: typeof sortedPosts[number]): BlogPost {
  // CollectionEntry<'blog'>를 BlogPost 타입으로 변환 (필요한 경우)
  // 현재 구조상 직접 사용 가능하거나 약간의 변환 필요할 수 있음
  // PostCard는 BlogPost 타입을 받음
  return post as unknown as BlogPost;
}
---

{(prevPost || nextPost) && (
  <nav class="post-navigation" aria-label="포스트 네비게이션">
    {prevPost && (
      <div class="nav-item">
        <div class="nav-label">이전 포스트</div>
        <PostCard post={convertToBlogPost(prevPost)} />
      </div>
    )}
    
    {nextPost && (
      <div class="nav-item">
        <div class="nav-label">다음 포스트</div>
        <PostCard post={convertToBlogPost(nextPost)} />
      </div>
    )}
  </nav>
)}

<style>
  .post-navigation {
    margin-top: 0;
    background: var(--color-bg-tertiary);
    padding: 2em 2.5em;
    border-top: none;
  }
  
  .nav-item {
    margin-bottom: 2rem;
  }

  .nav-item:last-child {
    margin-bottom: 0;
  }

  .nav-label {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }
  
  @media (max-width: 500px) {
    .post-navigation {
      padding: 30px 20px;
    }
  }
</style>
