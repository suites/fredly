---
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BlogPost from '@/layouts/BlogPost.astro';
import { getPostRouteSlug } from '@/utils/post-route.util';
import { extractDescription } from '@/utils/markdown';
import { getPostLocale } from '@/utils/translation-map.util';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const koPosts = posts.filter((post) => getPostLocale(post) !== 'en');
  
  return koPosts.map((post) => {
    // 우리 스타일의 slug 필드를 우선 사용, 없으면 id에서 추출
    const slug = getPostRouteSlug(post);
    
    // slug가 유효한지 확인
    if (!slug) {
      console.warn(`Post ${post.id} has no valid slug`);
      return null;
    }
    
    return {
      params: { slug },
      props: { post },
    };
  }).filter(Boolean); // null 제거
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

// 읽기 시간 계산 (간단한 추정)
const readTime = Math.ceil(post.body.split(/\s+/).length / 200);

// 설명 추출 (description이 없을 때 본문 내용 사용)
const seoDescription = post.data.description || extractDescription(post.body);

// 이미지 경로 해결을 위한 로직
let ogImage: string | undefined = undefined;

if (post.data.heroImage) {
  // heroImage가 있으면 그것을 사용 (이미 처리된 이미지 객체일 수 있음)
  // BlogPost에서 처리하므로 여기서는 undefined로 남겨둬도 되지만, 명시적으로 처리
  // (BlogPost 내부 로직이 있으므로 undefined로 둠 -> BlogPost가 post.data.heroImage를 씀)
  ogImage = undefined;
} else {
  // heroImage가 없으면 기본 ogp.png 사용 (성능 이슈로 동적 생성 임시 중단)
  ogImage = '/images/ogp.png';
}
---

<BlogPost {...post.data} headings={headings} readTime={readTime} ogImage={ogImage} ogDescription={seoDescription}>
  <Content />
</BlogPost>